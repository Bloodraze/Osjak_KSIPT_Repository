<?php
session_start(); // Запускаем сессию, чтобы обращаться к $_SESSION и хранить данные пользователя между запросами
$usersFile = 'users.json';
$goodsFile = 'goods.json';
// Проверка авторизации
if (!isset($_SESSION['user'])) { // Если в сессии нет ключа 'user', значит пользователь не авторизован
    echo "<p>Вы не авторизованы. <a href='shop.php'>Перейти к авторизации</a></p>"; // Сообщаем и даем ссылку на страницу магазина/логина
    exit; // Прерываем выполнение скрипта, дальше код не выполняется
}
$currentUser = $_SESSION['user']; // Сохраняем данные текущего пользователя из сессии в переменную
// Загружаем пользователей
$users = []; // Инициализируем массив пользователей как пустой
if (file_exists($usersFile)) { // Проверяем, существует ли файл с пользователями
    $usersData = file_get_contents($usersFile); // Читаем содержимое файла в строку
    $users = json_decode($usersData, true); // Преобразуем JSON-строку в ассоциативный массив (true = ассоциативный)
    if (!is_array($users)) { // Если декодирование не вернуло массив (например, файл поврежден)
        $users = []; // Сбрасываем в пустой массив для безопасности
    }
}
// Загружаем товары
$products = []; // Инициализируем массив товаров как пустой
if (file_exists($goodsFile)) { // Проверяем, существует ли файл с товарами
    $goodsData = file_get_contents($goodsFile); // Читаем содержимое файла товаров
    $products = json_decode($goodsData, true); // Преобразуем JSON-строку в массив
    if (!is_array($products)) { // Если декодирование не удалось или результат не массив
        $products = []; // Сбрасываем в пустой массив
    }
}
// Приводим favourite-поля к массиву
foreach ($users as &$u) { // Перебираем всех пользователей по ссылке (& для изменения оригинального массива)
    if (!isset($u['favourites']) or !is_array($u['favourites'])) { // Если нет ключа favourites или он не массив
        $u['favourites'] = []; // Создаем пустой массив избранного для такого пользователя
    }
}
unset($u); // Разрываем ссылку на последний элемент после foreach (хорошая практика)
// Обработка удаления из избранного (GET или POST)
$removeId = null; // Инициализируем переменную ID товара для удаления как null
if (isset($_GET['remove_id'])) { // Если ID передан через GET-параметр
    $removeId = (int)$_GET['remove_id']; // Приводим значение к целому числу
} elseif (isset($_POST['remove_id'])) { // Если ID передан через POST-параметр
    $removeId = (int)$_POST['remove_id']; // Аналогично приводим к целому
}
if ($removeId !== null) { // Если есть ID товара для удаления
    foreach ($users as &$u) { // Перебираем пользователей по ссылке
        if ($u['login'] === $currentUser['login']) { // Находим запись текущего пользователя по логину
            // Фильтруем массив favourites, убирая элемент с указанным ID
            $u['favourites'] = array_values( // array_values переиндексирует массив после фильтрации
                array_filter($u['favourites'], function($id) use ($removeId) { // Оставляем только те ID, что не равны $removeId
                    return $id != $removeId; // Если ID не совпадает с удаляемым, он остается в массиве
                })
            );
            $currentUser = $u; // Обновляем локальные данные текущего пользователя
            $_SESSION['user'] = $u; // Обновляем пользователя в сессии
            break; // Прерываем цикл, нужный пользователь найден и обновлен
        }
    }
    unset($u); // Разрываем ссылку после цикла
    // Сохраняем обновлённый массив пользователей в файл
    file_put_contents(
        $usersFile,
        json_encode($users, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT) // Кодируем массив в JSON с сохранением Юникода и красивым форматированием
    );
    echo "<p>Товар удалён из избранного.</p>"; // Выводим сообщение об успешном удалении
}
// Список избранных товаров
$favIds = []; // Массив для хранения ID избранных товаров текущего пользователя
foreach ($users as $u) { // Перебираем всех пользователей
    if ($u['login'] === $currentUser['login']) { // Находим текущего пользователя по логину
        $favIds = $u['favourites']; // Берем его массив избранных ID
        break; // Прерываем цикл, нужный пользователь найден
    }
}
// Индексируем товары по id для быстрого поиска
$productsById = []; // Массив, где ключом будет ID товара, а значением — сам товар
foreach ($products as $p) { // Перебираем все товары
    if (isset($p['id'])) { // Проверяем, есть ли у товара поле id
        $productsById[$p['id']] = $p; // Сохраняем товар по ключу его ID
    }
}
// Заголовок страницы с именем текущего пользователя
echo "<h1>Избранные товары пользователя {$currentUser['name']}</h1>";
if (empty($favIds)) { // Если массив избранных ID пуст
    echo "<p>У вас пока нет избранных товаров.</p>"; // Сообщаем, что избранного пока нет
} else {
    // Перебираем все ID избранных товаров
    foreach ($favIds as $pid) {
        if (!isset($productsById[$pid])) { // Если товара с таким ID уже нет в списке товаров
            continue; // Пропускаем этот ID
        }
        $product = $productsById[$pid]; // Получаем полную информацию о товаре по ID
        echo "<div style='margin-bottom:15px;'>"; // Контейнер для карточки товара с отступом снизу
        if (!empty($product['imageUrl'])) { // Если у товара есть ссылка на изображение
            // Выводим изображение товара с заданным максимальным размером
            echo "<img src='{$product['imageUrl']}' alt='{$product['name']}' style='max-width: 120px; max-height: 90px;'><br>";
        }
        echo "<b>{$product['name']}</b><br>"; // Название товара жирным
        echo "Цена: {$product['price']} руб.<br>"; // Выводим цену товара
        echo "Категория: {$product['category']}<br>"; // Выводим категорию товара
        // Ссылка для удаления этого товара из избранного (передаем его ID в параметре remove_id)
        echo "<a href='?remove_id={$product['id']}'>Удалить из избранного</a>";
        echo "</div>"; // Закрываем блок карточки
    }
}
// Ссылка для возврата в магазин
echo "<p><a href='shop.php'>Вернуться в магазин</a></p>";